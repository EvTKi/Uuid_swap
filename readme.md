# Замена GUID в XML по CSV (PySide6 GUI)

## Описание функций

### `main_ui.py`
- **GUIDReplacer** – основной класс графического интерфейса.
- `pick_xml()`, `pick_csv()` — выбор исходных файлов.
- `try_render_preview()` — предпросмотр замен, отображение подсветки и дерева структуры.
- `replace_guids()` — запуск процесса замены, сохранение результата и автоматическое обновление CSV с новыми UID.
- `xmltree_item_clicked()` — навигация по дереву с учётом родителя выбранного тега.
- `find_next()` — поиск по предпросмотру текста.
- `build_xml_tree_with_ns()` — построение дерева с пространствами имён.
- `build_tag_parent_map()` — карта соответствий для корректного поиска одинаковых тегов в разных родителях.

### `backend.py`
- `load_guid_map(csv_path)` — загрузка сопоставлений из CSV (`old_uid;new_uid`). Возвращает:
    - словарь UID,
    - информацию о сгенерированных UID,
    - список всех строк для возможной перезаписи CSV,
    - имена столбцов.
- `write_guid_map(csv_path, all_rows, fieldnames)` — запись актуальных UID обратно в CSV.
- `read_text_file(path)`, `save_text_file(path, text)` — чтение и запись текста.
- `find_uid_matches(xml_text, guid_map)` — поиск всех совпадений старых UID.
- `replace_guids(xml_text, guid_map)` — замена всех найденных UID на новые.

---

## Логика работы

1. Пользователь выбирает XML-файл и CSV-таблицу соответствий через GUI.
2. Показывается предварительный просмотр будущей замены и дерево структуры XML.
3. Все совпадения UID подсвечиваются; дерево привязывает повторяющиеся теги к родительским элементам.
4. Поиск по предпросмотру доступен с выделением найденных совпадений.
5. Кнопка "Выполнить замену" создает новый файл с подменёнными UID и автоматически вписывает недостающие new_uid обратно в CSV.

---

## Формат исходных файлов

### XML

- Валидный XML-документ, поддерживаются пространства имён.
- Пример:
    ```xml
    <cim:Folder rdf:about="#_guid1">
      <cim:IdentifiedObject.name>Sample</cim:IdentifiedObject.name>
      <cim:Folder.CreatingNode rdf:resource="#_guid2" />
    </cim:Folder>
    ```

### CSV
- Формат: `old_uid;new_uid`, кодировка UTF-8, разделитель — `;`.
- Если `new_uid` не указан — генерируется автоматически и вписывается обратно при замене.
- Пример:
    | old_uid | new_uid      |
    | ------- | ------------ |
    | guid1   | newguid1-xxx |
    | guid2   | newguid1-xxx |
    

---

## Как использовать скрипт

1. Установить зависимости:
    ```bash
    pip install PySide6
    ```
2. Поместить `main_ui.py` и `backend.py` в одну папку.
3. Запустить:
    ```bash
    python main_ui.py
    ```
4. Выбрать XML и CSV через интерфейс.
5. Посмотреть предпросмотр изменений, использовать поиск и дерево.
6. Нажать "Выполнить замену" для генерации нового файла (`*_output.xml`) и автоматического обновления исходного CSV с новыми UID.

---

## Результаты

- Получаете новый XML-файл с заменёнными UID.
- Все замены видны в предпросмотре: старый UID — красный, зачёркнутый; новый — зелёный.
- Дерево структуры позволяет переходить к повторяющимся тегам конкретного родителя.
- Исходный CSV автоматически обновляется — сгенерированные new_uid дополняются в таблицу.
- Сообщения об ошибках показываются в окне программы.

---

## Особенности

- Точная навигация по тегам с учётом родителя (корректные переходы при повторяющихся вложениях).
- Полная подсветка всех заменяемых значений.
- Автоматическая генерация и дописывание новых UID.
- Светлая/тёмная тема, горячие клавиши интерфейса.
- Поиск по предпросмотру (циклический).

---

## Требования

- Python 3.8+
- PySide6
- Операционная система Windows, Linux или macOS
- Файлы XML и CSV в кодировке UTF-8, CSV с разделителем `;`

---

## Примечания

- Для крупных XML-файлов (>100МБ) возможны задержки в работе предпросмотра.
- При ошибках структуры или чтения — программа выводит подробные сообщения.
- Можно адаптировать код для других видов тегов и любых правил замены.
- Все вхождения каждого найденного старого UID заменяются на новые, а новые UID вписываются в CSV автоматически.

---
